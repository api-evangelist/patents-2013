---

title: Machine vision inspection system and method for performing high-speed focus height measurement operations
abstract: A machine vision inspection system comprising an illumination source and an imaging system and a method for performing high-speed focus height measurement operations. The method comprises: placing a workpiece in a field of view of the machine vision inspection system; determining a region of interest for focus height measurement operations; operating the illumination source to illuminate the workpiece with strobed illumination; periodically modulating a focus position of the imaging system along a Z-height direction proximate to the workpiece; collecting an image stack, wherein each image of the image stack corresponds to an instance of strobed illumination matched with a phase of the modulated focus position corresponding to an appropriate Z height within the image stack; and determining a Z-height measurement for at least one portion of the region of interest.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09143674&OS=09143674&RS=09143674
owner: Mitutoyo Corporation
number: 09143674
owner_city: Kawasaki-shi
owner_country: JP
publication_date: 20130613
---
The invention relates generally to machine vision inspection systems and more particularly to height measurements from focus operations.

Precision machine vision inspection systems or vision systems for short can be utilized to obtain precise dimensional measurements of inspected objects and to inspect various other object characteristics. Such systems may include a computer a camera and optical system and a precision stage that is movable in multiple directions to allow workpiece inspection. One exemplary prior art system that can be characterized as a general purpose off line precision vision system is the commercially available QUICK VISION series of PC based vision systems and QVPAK software available from Mitutoyo America Corporation MAC located in Aurora Ill. The features and operation of the QUICK VISION series of vision systems and the QVPAK software are generally described for example in the QVPAK 3D CNC Vision Measuring Machine User s Guide published January 2003 and the QVPAK 3D CNC Vision Measuring Machine Operation Guide published September 1996 each of which is hereby incorporated by reference in their entirety. This type of system is able to use a microscope type optical system and move the stage so as to provide inspection images of either small or relatively large workpieces at various magnifications.

General purpose precision machine vision inspection systems such as the QUICK VISION system are also generally programmable to provide automated video inspection. Such systems typically include GUI features and predefined image analysis video tools such that operation and programming can be performed by non expert operators. For example U.S. Pat. No. 6 542 180 which is incorporated herein by reference in its entirety teaches a vision system that uses automated video inspection including the use of various video tools. One known type of video tool is a multipoint tool or a multipoint autofocus tool video tool. Such a tool provides Z height measurements or coordinates along the optical axis and focusing axis of the camera system derived from a best focus position for a plurality of sub regions at defined X Y coordinates within a region of interest of the tool such as determined by an autofocus method. A set of such X Y Z coordinates may be referred as point cloud data or a point cloud for short. In general according to prior art autofocus methods and or tools the camera moves through a range of positions along a Z axis the focusing axis and captures an image at each position referred to as an image stack . For each captured image a focus metric is calculated for each sub region based on the image and related to the corresponding position of the camera along the Z axis at the time that the image was captured. This results in focus curve data for each sub region which may be referred to simply as a focus curve or autofocus curve. The peak of the focus curve which corresponds to the best focus position along the z axis may be found by fitting a curve to the focus curve data and estimating the peak of the fitted curve. Variations of such autofocus methods are well known in the art. For example one known method of autofocusing similar to that outlined above is discussed in Robust Autofocusing in Microscopy by Jan Mark Geusebroek and Arnold Smeulders in ISIS Technical Report Series Vol. 17 November 2000. Another known autofocus method and apparatus is described in U.S. Pat. No. 5 790 710 which is hereby incorporated by reference in its entirety.

The machine control instructions including the specific inspection event sequence i.e. how to acquire each image and how to analyze inspect each acquired image are generally stored as a part program or workpiece program that is specific to the particular workpiece configuration. For example a part program defines how to acquire each image such as how to position the camera relative to the workpiece at what lighting level at what magnification level etc. Further the part program defines how to analyze inspect an acquired image for example by using one or more video tools such as autofocus video tools.

Video tools or tools for short and other graphical user interface features may be used manually to accomplish manual inspection and or machine control operations in manual mode . Their set up parameters and operation can also be recorded during learn mode in order to create automatic inspection programs or part programs. Video tools may include for example edge boundary detection tools autofocus tools shape or pattern matching tools dimension measuring tools and the like.

In various applications it is desirable to perform high speed autofocus operations to facilitate high speed 3 D measurements in either stationary or non stop moving inspection systems. Laser triangulation techniques may provide a 2000 1 range to resolution ratio but typical systems employing such techniques have a lower limit of 4 m resolution for Z height measurements and do not provide comparable lateral resolution to exemplary machine vision inspection systems. The speed of autofocus operations in conventional machine vision inspection systems is limited by the motion of the camera through a range of Z height positions. There is a need for improved autofocus operations utilizing alternative methods of collecting a stack of images for measuring Z height positions with high speed.

Those skilled in the art will appreciate that the controlling computer system may generally consist of any computing system or device. Suitable computing systems or devices may include personal computers server computers minicomputers mainframe computers distributed computing environments that include any of the foregoing and the like. Such computing systems or devices may include one or more processors that execute software to perform the functions described herein. Processors include programmable general purpose or special purpose microprocessors programmable controllers application specific integrated circuits ASICs programmable logic devices PLDs or the like or a combination of such devices. Software may be stored in memory such as random access memory RAM read only memory ROM flash memory or the like or a combination of such components. Software may also be stored in one or more storage devices such as magnetic or optical based disks flash memory devices or any other type of non volatile storage medium for storing data. Software may include one or more program modules that include routines programs objects components data structures and so on that perform particular tasks or implement particular abstract data types. In distributed computing environments the functionality of the program modules may be combined or distributed across multiple computing systems or devices and accessed via service calls either in a wired or wireless configuration.

The vision measuring machine includes a moveable workpiece stage and an optical imaging system that may include a zoom lens or interchangeable lenses. The zoom lens or interchangeable lenses generally provide various magnifications for the images provided by the optical imaging system . The machine vision inspection system is generally comparable to the QUICK VISION series of vision systems and the QVPAK software discussed above and similar state of the art commercially available precision machine vision inspection systems. The machine vision inspection system is also described in commonly assigned U.S. Pat. Nos. 7 454 053 7 324 682 8 111 905 and 8 111 938 each of which is incorporated herein by reference in its entirety.

The optical assembly portion is controllably movable along a Z axis that is generally orthogonal to the X and Y axes by using a controllable motor that drives an actuator to move the optical assembly portion along the Z axis to change the focus of the image of the workpiece . The controllable motor is connected to the input output interface via a signal line .

A workpiece or a tray or fixture holding a plurality of workpieces which is to be imaged using the machine vision inspection system is placed on the workpiece stage . The workpiece stage may be controlled to move relative to the optical assembly portion such that the interchangeable objective lens moves between locations on a workpiece and or among a plurality of workpieces . One or more of a stage light a coaxial light and a surface light e.g. a ring light may emit source light and or respectively to illuminate the workpiece or workpieces . The light source may emit light along a path including a mirror . The source light is reflected or transmitted as workpiece light and the workpiece light used for imaging passes through the interchangeable objective lens and the turret lens assembly and is gathered by the camera system . The image of the workpiece s captured by the camera system is output on a signal line to the control system portion . The light sources and may be connected to the control system portion through signal lines or busses and respectively. To alter the image magnification the control system portion may rotate the turret lens assembly along axis to select a turret lens through a signal line or bus .

As shown in in various exemplary embodiments the control system portion includes a controller the input output interface a memory a workpiece program generator and executor and a power supply portion . Each of these components as well as the additional components described below may be interconnected by one or more data control buses and or application programming interfaces or by direct connections between the various elements.

The input output interface includes an imaging control interface a motion control interface a lighting control interface and a lens control interface . The motion control interface may include a position control element and a speed acceleration control element although such elements may be merged and or indistinguishable. The lighting control interface includes lighting control elements and that control for example the selection power on off switch and strobe pulse timing if applicable for the various corresponding light sources of the machine vision inspection system .

The memory may include an image file memory portion an edge detection memory portion a workpiece program memory portion that may include one or more part programs or the like and a video tool portion . The video tool portion includes video tool portion and other video tool portions e.g. that determine the GUI image processing operation etc. for each of the corresponding video tools and a region of interest ROI generator that supports automatic semi automatic and or manual operations that define various ROIs that are operable in various video tools included in the video tool portion . The video tool portion also includes an autofocus video tool which determines the GUI image processing operation etc. for focus height measurement operations. The autofocus video tool additionally includes a high speed focus height tool that may be utilized to measure focus heights with high speed according to operations described with respect to using hardware described in . In some embodiments the high speed focus height tool may be a special mode of the autofocus video tool that may otherwise operate according to conventional methods for autofocus video tools. In some embodiments the operations of the autofocus video tool may only include those of the high speed focus height tool . In the context of this disclosure and as known by one of ordinary skill in the art the term video tool generally refers to a relatively complex set of automatic or programmed operations that a machine vision user can implement through a relatively simple user interface e.g. a graphical user interface editable parameter windows menus and the like without creating the step by step sequence of operations included in the video tool or resorting to a generalized text based programming language or the like. For example a video tool may include a complex pre programmed set of image processing operations and computations that are applied and customized in a particular instance by adjusting a few variables or parameters that govern the operations and computations. In addition to the underlying operations and computations the video tool comprises the user interface that allows the user to adjust those parameters for a particular instance of the video tool. For example many machine vision video tools allow a user to configure a graphical region of interest ROI indicator through simple handle dragging operations using a mouse in order to define the location parameters of a subset of an image that is to be analyzed by the image processing operations of a particular instance of a video tool. It should be noted that the visible user interface features are sometimes referred to as the video tool with the underlying operations being included implicitly.

The signal lines or busses and of the stage light the coaxial lights and and the surface light respectively are all connected to the input output interface . The signal line from the camera system and the signal line from the controllable motor are connected to the input output interface . In addition to carrying image data the signal line may carry a signal from the controller that initiates image acquisition.

One or more display devices e.g. the display of and one or more input devices e.g. the joystick keyboard and mouse of can also be connected to the input output interface . The display devices and input devices can be used to display a user interface that may include various graphical user interface GUI features that are usable to perform inspection operations and or to create and or modify part programs to view the images captured by the camera system and or to directly control the vision system components portion . The display devices may display user interface features associated with the autofocus video tool

In various exemplary embodiments when a user utilizes the machine vision inspection system to create a part program for the workpiece the user generates part program instructions by operating the machine vision inspection system in a learn mode to provide a desired image acquisition training sequence. For example a training sequence may comprise positioning a particular workpiece feature of a representative workpiece in the field of view FOV setting light levels focusing or autofocusing acquiring an image and providing an inspection training sequence applied to the image e.g. using an instance of one of the video tools on that workpiece feature . The learn mode operates such that the sequence s are captured or recorded and converted to corresponding part program instructions. These instructions when the part program is executed will cause the machine vision inspection system to reproduce the trained image acquisition and cause inspection operations to automatically inspect that particular workpiece feature that is the corresponding feature in the corresponding location on a run mode workpiece or workpieces which matches the representative workpiece used when creating the part program.

In operation the light source is configured to emit source light along a path including a mirror to a surface of a workpiece the objective lens is configured to receive workpiece light that is focused at a focal plane F proximate to the workpiece and output the workpiece light to the relay lens . The relay lens is configured to receive the workpiece light and output it to the relay lens . The relay lens is configured to receive the workpiece light and output it to the variable focal length lens . Together the relay lens and the relay lens provide a optical relay between the objective lens and the variable focal length lens in order to provide constant magnification for each Z height. The variable focal length lens is configured to receive the workpiece light and output it to the tube lens . The variable focal length lens is electronically controllable to vary the focus position of the imaging system and collect an image stack comprising respective images focused at respective Z heights wherein each image of the image stack corresponds to an instance of strobed illumination timed to correspond with a phase of the periodically modulated focus position corresponding to a Z height within the image stack.

In various embodiments a machine vision inspection system adapted to the principles disclosed herein is configurable to determine a region of interest within a field of view for focus height measurement operations and determine a Z height measurement for at least one portion of the region of interest based on analyzing the image stack to determine a Z height corresponding to a best focus position for the at least one portion of the region of interest. The position of the focal plane F may be moved within a range R bound by a focal plane F1 and a focal plane F2. In various embodiments a machine vision inspection system comprises a control system e.g. the control system that is configured to control the variable focal length lens to periodically modulate a focus position of the imaging system . In some embodiments the variable focal length lens may modulate the focus position at a rate of at least 20 kHz. In some embodiments the range R may be as large as 300 m. The variable focal length lens is advantageous in that it does not require any adjustment of the distance between the objective lens and the workpiece . This allows for high speed in collecting an image stack for measuring a Z height of a portion of the workpiece based on a best focus height the speed of which is limited primarily by the frame rate of the camera system .

In some embodiments the variable focal length lens is a tunable acoustic gradient index of refraction lens. A tunable acoustic gradient index of refraction lens is a high speed variable focal length lens that uses sound waves in a fluid medium to modulate a focus position and may periodically sweep a range of focal lengths at a frequency of several hundred kHz. Such a lens may be understood by the teachings of the article High speed varifocal imaging with a tunable acoustic gradient index of refraction lens Optics Letters Vol. 33 No. 18 Sep. 15 2008 which is hereby incorporated by reference in its entirety.

In some embodiments the camera system may comprise a sensor with a global shutter i.e. a sensor that exposes each pixel simultaneously. Such an embodiment is advantageous in that it provides the capability to measure image stacks without motion of a workpiece or any part of the imaging system .

In some embodiments the camera system may comprise a sensor with an electronic rolling shutter ERS system. For example the camera system may comprise a black and white CMOS sensor using SXGA resolution coupled with an electronic rolling shutter ERS system e.g. model MT9M001 from Aptina Imaging of San Jose Calif. . The maximum number of images in a stack is limited by the ratio of the vertical resolution of the CMOS sensor to the width of pixel arrays used for determining a contrast metric. For example a CMOS sensor with SXGA resolution has a resolution of 1280 1024 pixels. Thus for focus operations using 7 7 pixel sub regions this limits the number of images per stack to 146 images. A higher resolution sensor such as a 2592 1944 HD sensor allows for wider sub regions e.g. 13 13 sub regions for an image stack of 146 images. Alternatively a higher resolution sensor with a 2592 1944 resolution may utilize 7 7 pixel sub regions for an image stack of 278 images. Such embodiments will be described in further detail with respect to .

In some embodiments the variable focal length lens may be driven sinusoidally such that the optical power of the variable focal length lens is modulated sinusoidally. In exemplary embodiments a tunable acoustic gradient index of refraction lens may be configured for focal scanning rates as high as 400 kHz. The maximum number of images in a stack is limited by the period with which the variable focal length lens is modulated and the length of time of light pulse durations associated with each image exposure. For a focus modulation period of 13.9 s and a light pulse duration of 50 ns this limits the number of images per stack to . The vertical line scanning frequencies of image detectors such as that of Aptina are on the order of kHz. For example the model MT9M001 from Aptina may be configured for a line scan frequency of 37.5 kHz based on a data scan rate of 48 MHz over 1280 pixels . Such detectors must be configured such that the frequency is less than the modulation frequency of the variable focal length lens .

In some embodiments the imaging system may comprise an optional beamsplitter an optional tube lens and an optional second camera system . In operation the beamsplitter is configured to split the workpiece light and output workpiece light to the tube lens . The tube lens is configured to output the workpiece light to the camera in order to provide an additional image of the field of view of the machine vision inspection system. A detailed configuration of such a system is illustrated in .

Although in the imaging array A and the imaging array B are juxtaposed it should be appreciated that this is to schematically show their Y offset Y in the Y direction relative to an image of the field of view of the imaging system . The imaging array A and the imaging array B are actually in separate beam paths in an analogous manner to that shown in with respect to the first camera system and the second camera system . The embodiment shown in comprises two camera systems. However embodiments configured according to similar principles may comprise more than two camera systems. In such embodiments the offset Y is equal to the width of the sub regions used for determining a best focus height. The number of camera systems can reduce the Y pitch between stack locations. In an exemplary embodiment an imaging system comprises seven imaging arrays each of the imaging arrays is configured to image light offset relative to each other in a staggered manner by the offset Y that is at least equal to a width of the sub regions used for determining a best focus height. Thus for focus operations utilizing 7 7 pixel sub regions Y is equal to the width of seven pixels.

With focus measurement operations using an electronic rolling shutter system on a moving workpiece an image stack collected by the imaging array A and B comprises sub images corresponding to pixel stripes numbered PSAand PSBrather than images that use an entire pixel array. The pixel stripes PSAand PSBeach have widths that are the same number of pixels as the sub regions used for determining focus metrics. For example in the exemplary embodiment shown in the pixel stripes PSAand PSBare seven pixels wide and the sub regions used for determining focus metrics are 7 7 pixels. Image stacks collected by the imaging array A and the imaging array B thus include 146 images that are 7 1280 pixels. Each of the images corresponds to a Z height Z i.e. the variable focal length lens is focused at that respective Z height in its phase of modulation corresponding to the times t.

In the exemplary embodiment shown in the imaging system comprises two imaging arrays. However in various embodiments an imaging system configured according to similar principles may have only one imaging array or more than two imaging arrays. Multiple imaging arrays improve the measurement volume in the Y direction. For example using the same parameters described with respect to a camera system comprising a single imaging array may have a measurement volume of 1.331 0.007 0.292 mm and an imaging system comprising two imaging arrays separated by seven pixels in the Y direction may have a measurement volume of 1.331 0.014 0.292 mm. An imaging system comprising N imaging arrays staggered by seven pixels in the Y direction may have a measurement volume of 1.331 0.007 N 0.292 mm. Multiple imaging arrays also improve measurement pitch in the Y direction. In one exemplary embodiment the workpiece may be moved relative to the field of view of the imaging system at a speed in the Y direction Sthat is at least 5 mm s and at most 39 mm s. Thus using the same parameters described with respect to a camera system comprising a single imaging array may have a measurement pitch between 0.132 mm and 1.057 mm and an imaging system comprising two imaging arrays separated by seven pixels in the Y direction may have a measurement pitch between 0.067 mm and 0.53 mm. An imaging system comprising N imaging arrays staggered by seven pixels in the Y direction may have a measurement pitch between 0.132 N mm and 1.057 N mm. A machine vision inspection system configured using the same parameters described with respect to may provide measurement resolutions in X Y and Z directions of 0.001 mm 0.002 mm and 0.002 mm respectively. In comparison an exemplary laser triangulation system such as the Micro Epsilon Scancontrol 2800 10 may provide resolutions in X and Z directions of 0.040 mm and 0.004 mm respectively. The Y resolution of an exemplary embodiment is coarser. However for Sbetween 5 mm s and 39 mm s the 2800 10 system provides a measurement pitch in the Y direction that is at least 0.015 mm.

An exemplary sensor that may be suitable for the imaging array is model P4 CM 02K10D 00 R from Teledyne Dalsa of Waterloo Ontario Canada that comprises an array which has a width of 2048 pixels and a line rate of 140 kHz. This sensor comprises two lines of pixels that may be summed or used independently of one another. Similar sensors with a single line of pixels are also available and suitable for the embodiment shown in .

In some exemplary embodiments an inexpensive light source may have a light pulse duration of 50 ns and a focus modulation rate of 72 kHz that is capable of 278 timing increments for collecting an image stack. Such an embodiment may have a range R of approximately 100 depths of focus of the imaging system . In some exemplary embodiments an advanced light source may have a light pulse duration of 2 ns and a focus modulation rate of 72 kHz that is capable of 6 950 timing increments for collecting an image stack. Such an embodiment may have a range R of approximately 2 500 depths of focus of the imaging system .

It should be appreciated that a one dimensional imaging array with a line rate of 140 kHz or a higher line rate of 280 kHz is capable of collecting an image stack through a single cycle of a typical tunable acoustic gradient index of refraction lens operating at 72 kHz. A machine vision inspection system configured using the same parameters described with respect to with a field of view moving at a comparable speed compared to the imaging system of S 33 mm sec may provide measurement resolutions in X Y and Z directions of 0.001 mm 0.010 mm and 0.002 mm respectively.

At block a focus position of the imaging system is periodically modulated over a plurality of positions along a Z height direction proximate to the workpiece.

At block an image stack is collected comprising respective images focused at respective Z heights wherein each image of the image stack is exposed using an instance of strobed illumination timed to correspond with a phase of the periodically modulated focus position corresponding to a Z height within the image stack.

At block a Z height measurement is determined for at least one portion of the region of interest based on analyzing the image stack to determine a Z height corresponding to a best focus position for the at least one portion of the region of interest. In some embodiments the at least one portion of the region of interest may be a sub region of the region of interest. In some embodiments the at least one portion of the region of interest may be the entire region of interest. In some embodiments determining a Z height measurement for at least one portion of the region of interest may comprise determining a Z height measurement for a plurality of sub regions of the region of interest.

It should be appreciated that embodiments of a machine vision inspection system configured according to the principles disclosed herein provide certain advantages over laser triangulation based systems. For example such systems produce no laser speckle and thus no eye safety hazard. Through the lens measurement is possible e.g. in the embodiment shown in which means there is no potential obstruction or shadowing. Furthermore components such as the illumination source CMOS imaging arrays and the required support electronics are inexpensive.

While the preferred embodiment of the invention has been illustrated and described numerous variations in the illustrated and described arrangements of features and sequences of operations will be apparent to one skilled in the art based on this disclosure. Thus it will be appreciated that various changes can be made therein without departing from the spirit and scope of the invention.

