---

title: Data migration system
abstract: Described are techniques and systems to migrate data from a first data structure to a second data structure stored in datastores which are replicated with one another. A “hot” datastore is replicated with one or more “warm” datastores. Triggers maintain consistency between the first data structure and the second data structure. Migration may involve testing using the second data structure of the “warm” datastore. Data processed by the first data structure on the “hot” datastore is distributed via replication to the “warm” datastore, and then by a trigger to the second data structure. Data processed by the second data structure on the “warm” datastore is distributed via trigger to the first data structure, and then by replication to the “hot” datastore. Once performance of the second data structure is deemed acceptable, the “warm” datastore may be designated as “hot” and synonyms therein may direct data to the second data structure.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09607020&OS=09607020&RS=09607020
owner: Amazon Technologies, Inc.
number: 09607020
owner_city: Reno
owner_country: US
publication_date: 20130917
---
Many entities operate datastores used in high reliability situations. Medical organizations maintain patient records online retailers maintain information about products for sale and so forth.

Over time new datastores may be added schema changes may be contemplated or other changes to the datastores may be called for. Migration of data from one data structure to another or schema changes in production datastores is fraught with risk. Migration errors may result in failure of mission critical systems. This may result in loss or corruption of mission critical data loss of service and so forth.

Certain implementations and embodiments will now be described more fully below with reference to the accompanying figures in which various aspects are shown. However various aspects may be implemented in many different forms and should not be construed as limited to the implementations set forth herein. Like numbers refer to like elements throughout.

Many entities use datastores to store and manipulate data. These datastores may include relational databases object oriented databases distributed data stores flat files non relational databases and so forth.

The entities using these datastores may seek to maintain a high level of reliability to services accessing these datastores. For example a particular datastore may be mission critical in that a failure would severely impact or cause cessation of core functions of that entity. As a result these entities seek to minimize or eliminate these risks. However several operations performed by datastore administrators have traditionally increased the risk of failure in the datastore. These operations may include data migration schema changes and so forth.

Described in this disclosure are systems and techniques for performing data migration schema changes and so forth while reducing or eliminating risk of failure. A first datastore having a first data structure and a second data structure is configured to replicate data with a second datastore having a replicated version of the first data structure and a second data structure. The replication may be provided at a data storage layer by a storage layer service. A replication group designates two or more datastores across which one or more data structures are replicated. Within a single datastore multiple replication groups may exist contemporaneously. For example the first data structure may be within a first replication group while the second data structure may be within a second replication group. As a result of the replication changes to the data structure in one datastore are also effective at the corresponding replicated data structures in other datastores which participate in the replication group. Continuing the example the first data structure may be an existing table storing data for migration while the second data structure is the new table for use post migration.

A replicated datastore may be designated as a main or hot datastore or a backup or warm datastore. The main datastore is configured to be responsive to requests from one or more hosts for performing one or more operations on data in the data structures. During traditional operation the backup datastore is held in reserve and placed into operation upon failure or deactivation of the main datastore. Both the main and the backup datastore are thus able to be responsive to requests.

Within a given datastore one or more synonyms are configured to direct processing of data with regard to the data structures in the datastore. For example a synonym may be an alternative name for a table view query and so forth. The data to be processed may include a payload and metadata. The payload may include information to be added to one or more data structures operations to be performed and so forth. The metadata may include information such as identification of a program module on a host which generated the data.

Once replication has been established between the first or main datastore and the second or backup datastore one or more triggers may be configured on the second datastore. The triggers are configured to propagate changes between the first data structure and the second data structure as stored in the second datastore. For example a change to the second data structure would result in a trigger which makes a corresponding change in the first data structure. Because of the replication established between the first and second datastores the changes to the first data structure and the second data structure are provided to the corresponding data structures in the first datastore. Similarly a change to the first data structure in the first datastore is replicated to the first data structure in the second datastore and from there a trigger makes a corresponding change in the second data structure. By using the replication and triggers changes to one data structure flow through to the other data structures. The triggers are configured to prevent infinite loops or runaway operations. In one implementation the trigger may use one or more trigger parameters to analyze metadata. For example the trigger parameters may specify a module name authorized to activate the trigger. When the metadata matches the trigger parameters such as for a particular module providing the data in a datastore session the trigger may be activated. After use the metadata may be modified such that the triggers will not be activated a second time.

Additionally synonym data for the datastores is configured to direct processing of the data to a particular data structure. The first datastore may have first synonym data configured to direct data to the first data structure. The second datastore may have second synonym data configured to direct data to the second data structure. During the migration process the first datastore may continue to operate as the main handling the bulk of the processing of incoming data. However a selected group of one or more hosts may be configured to use the second datastore instead of the first datastore. The second datastore receives the data and based on the second synonym data processes the data using the second data structure. Once the operation of the second data structure is determined to be satisfactory the remaining hosts may be directed to use the second datastore as main while the first datastore is deprecated to backup status. The first synonym data may be updated such that data received at the first datastore is directed to the second data structure. The triggers may be deactivated and the system proceeds to use the second data structure which may continue to be replicated across the second replication group.

The techniques and systems described in this disclosure enable incremental testing and migration. As a result a particular host may be used to test the migrated data or changed schema before deployment to all hosts. The process of testing with a relatively small number of hosts known as one box testing thus becomes possible. Hosts may be transitioned between the first data structure and the second data structure at any time with data consistency maintained between the first data structure and the second data structure. The data structures may reside within different replication groups. As a result these techniques may be used to migrate data from one replication group to another.

The hosts communicatively couple to one or more networks . The network may include one or more public or private networks such as the Internet private wide area network and so forth. Data servers . . . N are also communicatively coupled to the one or more networks and may exchange information with the hosts . As illustrated here the hosts may send data to the data servers for processing. The data servers may be located in one or more physical locations. Furthermore the data servers may comprise one or more pieces of computing hardware. For example the data server may comprise a distributed computing system spread across multiple servers in more than one geographic location.

The data servers are configured to process the data . The data server may comprise a management module a replication module a trigger module and a datastore . The management module is configured to manage the processing operations of the data server . For example the management module may comprise a database management system.

The datastore is configured to contain information such as the data for manipulation. For example the datastore may comprise a database container. The datastore may include synonym data trigger parameters a first data structure a second data structure and other information.

Replication between the first data structure of the first datastore and the first data structure of the second datastore is illustrated. Similarly replication between the second data structure of the first datastore and the second data structure of the second datastore is established. Replication groups may be designated in which particular data structures are replicated across two or more datastores . The replication groups are discussed in more detail below with regard to .

The replication module is configured to support the replication between data servers datastores or both. The replication module may operate on a data storage layer. For example the replication module may work in conjunction with an operating system module see below to transfer blocks of information between data structures participating in replication. For example the management module may support infrastructure promulgated by Oracle Corp. of Redwood City Calif. and the replication module may implement the multi master replication MMR for use with Oracle databases.

The synonym data stores one or more synonyms. Synonyms direct processing of the data . In some implementations the synonyms may comprise pointers to the data structures in the datastore . For example a synonym may be an alternative name for a table view query and so forth. During the migration process the first synonym data of the first datastore may be configured to direct the data received at that datastore to the first data structure . Also during the migration process the second synonym data of the second datastore may be configured to direct the data received at that datastore to the second data structure . Functionality of the synonyms in the system is described in more detail below with regard to .

The trigger module is configured to activate one or more triggers . A particular trigger may be associated with one or more data structures. Activation of the trigger s may be based on a comparison or analysis of at least a portion of the data with the one or more trigger parameters . The trigger parameters specify one or more conditions for activation of the trigger s to occur. For example the trigger parameters may designate a datastore session associated with a particular module. Continuing the example the session from the particular module would activate the trigger while a session from another module not indicated by the trigger parameters would not. By configuring the trigger parameters the system can avoid processing the data more than once which may result in duplication or corruption of information in the data structures. As shown in this illustration the first data server omits the trigger module the trigger parameters and thus does not implement the one or more triggers . However in other implementations the data server or other data servers may include the trigger module the trigger parameters and the one or more triggers . The trigger parameters are discussed in more detail below with regard to .

The first data structure may comprise a table key value pairs linked list flat file collection of objects executable code script and so forth. The second data structure may comprise may comprise a table key value pairs linked list flat file collection of objects executable code script and so forth. The first data structure and the second data structure may but need not have similar structures. In one example the first data structure and the second data structure may comprise relational tables. In another example the first data structure may comprise a relational database while the second data structure may comprise an object oriented database. Two data structures and are depicted by way of illustration and not necessarily as a limitation. The datastore may contain more than two data structures.

Because of the replication and the triggers changes to the first data structure the second data structure whether at the main datastore or the backup datastore are propagated throughout the system. This is discussed in more detail below with regard to .

The trigger parameters may include a module name . The module name is configured to indicate an executable module or service which has provided or is requesting the data . The trigger parameters may include a session identifier . The session identifier provides information about a particular interaction between the host and the datastore . For example when the host begins the process of querying the datastore for data a session may be established between the management module and the datastore the host and the management module and so forth.

The trigger parameters may also include a connection protocol type . The connection protocol type may provide information indicative of a protocol used by the host to interact with the data server . For example the connection protocol type may indicate transmission control protocol internet protocol TCP IP TCP IP with secure socket layer SSL named pipes sockets direct protocol SDP and so forth.

A source network address may be included in the trigger parameters . The source network address may comprise the internet protocol address media access control address and so forth associated with the connection established by the host to the data server using the network .

Other data P may also be included in the trigger parameters such as a device identifier device type and so forth. For example the device type may indicate a particular type of host such as a server particular model of tablet computer and so forth.

As described above the trigger module may use one or more of the trigger parameters to determine whether to activate one or more triggers . The data may be inspected to determine the presence of one or more trigger parameters associated with a trigger . For example metadata which indicates a module name of ModuleA may result in activation of the trigger .

In the second synonym state the synonym data has been changed such as by the management module . The synonym data now provides the synonym of CUST 124 . This synonym data when processed by the management module now directs the data to the second data structure .

The synonym data may be changed while the datastore is in operation. In some implementations changes to the synonym data may result in a brief pause or suspension in transactions to and from the datastore . In other implementations no such pause or suspension may be experienced.

By changing the synonym data the data may be directed to different data structures within the datastore . During the migration process the management module may configure the first synonym data of the first datastore to direct the data received at that datastore to the first data structure . Also during the migration process the second synonym data of the second datastore may be configured to direct the data received at that datastore to the second data structure .

While in the main configuration the hosts have been configured to direct the data to the first data server and the corresponding main datastore . The synonym data provides a synonym which directs the data to the first data structure . For example the data may comprise adding a row of data. The synonym in the synonym data directs the management module to process the transaction using the data with regard to the first data structure . As a result the first data structure stored in the first datastore has the row of data added.

Because replication is established between the first datastore and the second datastore changes to one datastore are propagated to the other. As a result the data or the resulting changes to the first data structure are made to the first data structure in the second datastore .

The trigger module of the data server having the second datastore processes the data to determine if one or more trigger parameters are present which would result in activation of one or more triggers . Continuing the example the metadata includes the module name which is specified in the trigger parameters activating the trigger . The trigger propagates the information in the row of data to be added to the second data structure . The propagations may include copying merging updating transforming and so forth. For example the propagation may include mapping one or more fields in the first data structure to one or more other fields in the second data structure . Based on the action of the trigger the second data structure now includes the data or information based on the data . As above due to the replication between the second datastore and the first datastore the information in the second data structure is provided to the second data structure in the first datastore . The data now is propagated across the different data structures in the different datastores.

While in the migration configuration a first set of one or more hosts provide the data to the second datastore of the second data server . Meanwhile a second set of other hosts provide the data to the first datastore of the first data server . The first set of hosts may thus be used to test the operation of the second data structure the second datastore or both while leaving the second set of hosts unaffected.

As illustrated here the host provides the data to the second datastore . In one implementation the hosts may be configured to direct the data to a particular data server datastore or both. In another implementation the hosts may communicate with a server or use a network address which then routes the data to a particular data server .

The data is received by the second data server . The synonym data is configured to direct the data to the second data structure . Based on the synonym data the management module processes the data using the second data structure . As described above the trigger module may activate one or more triggers based on the metadata and the trigger parameters . The data is then propagated to the first data structure in the second datastore . As described above due to the replication the data is provided from the second data structure and the first data structure in the second datastore to the corresponding second data structure and first data structure in the first datastore .

The main configuration and the migration configuration may exist and operate simultaneously. For example as described above a first set of hosts N may send the data to the first data server while a second set of hosts N 1 H may send the data to the second data server .

The replication module may support replication across different datastores . Two or more datastores across which one or more data structures are replicated may be designated as a replication group. Within a datastore multiple replication groups may exist contemporaneously. For example as illustrated here a first replication group includes the replication between the first data structure of the first datastore and the first data structure of the second datastore .

In comparison a second replication group may include replication for the second data structure across the datastores D . For example the second replication group may include six participating datastores having replication modules configured to perform multi master replication between the six participating datastores .

Because of the replication changes to the data structure in one datastore are also effective at the corresponding replicated data structures in other datastores which participate in the replication group. By using the techniques described herein data may be migrated from one replication group to another. For example information which is available in the first replication group may be transferred to the second replication group by migrating data from the first data structure to the second data structure . In systems where the management modules typically need to pause or suspend operations associated with changes to replication groups the techniques described in this disclosure allow for movement of data from one replication group to another without such a pause or suspension.

The data server or system may include one or more processors configured to execute one or more stored instructions. The processors may comprise one or more cores. The data server may include one or more input output I O interface s to allow the processor or other portions of the data server to communicate with other devices. The I O interfaces may comprise inter integrated circuit I2C serial peripheral interface bus SPI Universal Serial Bus USB as promulgated by the USB Implementers Forum RS 232 and so forth.

The I O interface s may couple to one or more I O devices . The I O devices may include input devices such as one or more of a keyboard sensors 3D scanners and so forth. The I O devices may also include output devices such as one or more of a display printer and so forth. In some embodiments the I O devices may be physically incorporated with the data server or may be externally placed and communicatively coupled thereto.

The data server may also include one or more communication interfaces . The communication interfaces are configured to provide communications between the data server and other devices such as network attached storage the hosts user devices routers access points and so forth. The communication interfaces may include devices configured to couple to one or more networks including local area networks wide area networks and so forth.

The data server may also include one or more busses or other internal communications hardware or software that allow for the transfer of data between the various modules and components of the data server .

As shown in the data server includes one or more memories . The memory comprises one or more computer readable storage media CRSM . The CRSM may be any one or more of an electronic storage medium a magnetic storage medium an optical storage medium a quantum storage medium a mechanical computer storage medium and so forth. The memory provides storage of computer readable instructions data structures program modules and other data for the operation of the data server .

The memory may include at least one operating system OS module . The OS module is configured to manage hardware resource devices such as the I O interfaces the I O devices the communication interfaces and provide various services to applications or modules executing on the processors . Also stored in the memory may be one or more of the following modules. These modules may be executed as foreground applications background tasks daemons and so forth.

A communication module is configured to support communication between the data servers using the network . For example the communication module may implement a transmission control protocol internet protocol TCP IP stack for communication.

A user interface module may be configured to provide a user interface accessible to the hosts administrative users and so forth. This user interface may be provided as a graphical user interface such as web page expressed as markup language such as hypertext markup language HTML an application programming interface API and so forth.

The memory may also store the management module . As described above the management module is configured to manage the processing operations of the data server . For example the management module may comprise a database management system and corresponding datastore such as the Oracle RDBMS as provided by Oracle Corp. of Redwood City Calif. Microsoft SQL as provided by Microsoft Corp. of Seattle Wash. DynamoDB as provided by Amazon Web Services Inc. of Seattle Wash. and so forth.

The replication module may also be stored in the memory and provides replication services between data servers datastores or both. The replication module may operate on a data storage layer. For example the replication module may work in conjunction with the OS module to transfer blocks of information between data structures participating in replication . For example the replication module may support the Oracle multi master replication MMR for use with the Oracle RDBMS. In some implementations the replication module may be a part of the management module .

The memory may also store the trigger module . The trigger module is configured to activate one or more triggers . The triggers may be associated with one or more data structures. For example the trigger may be associated with the first data structure while the trigger may be associated with the second data structure . Activation of the trigger s may be based on a comparison or analysis of at least a portion of the data with the one or more trigger parameters .

Other modules may also be present. For example an authentication module may determine identity of the host while an access control module controls the activities of the host based at least in part on that identity.

The memory may also include the datastore to store information. The datastore may use a flat file database linked list tree executable code or other data structure to store the information. In some implementations the datastore or a portion of the datastore may be distributed across one or more other devices including servers network attached storage devices and so forth.

As depicted here the datastore may store one or more of the synonym data the trigger parameters the first data structure the second data structure or an N th data structure . Other data may also be stored in the datastore . For example the other data may include administrator permissions account information and so forth. A single datastore is depicted in the memory by way of illustration and not necessarily as a limitation. For example the data server may have more than one datastore .

The one or more hosts may comprise one or more of the components described above with regard to the data server . For example the host may include a processor memory and so forth.

Block designates a first set of hosts and a second set of hosts . For example the first set of hosts may comprise regular or default hosts while the second set of hosts may comprise those hosts slated for use in testing the migration.

Block accesses a first datastore and a second datastore wherein the first datastore and the second datastore comprise a first data structure and a second data structure replicated between the first datastore and the second datastore .

Block configures a first synonym in the first datastore to point to the first data structure . For example the synonym data may indicate CUST 122 .

Block configures a second synonym in the second datastore to point to the second data structure . For example the synonym data may indicate CUST 124 .

Block configures the first set of hosts to communicate with the first datastore and the second set of hosts to communicate with the second datastore . In some implementations the configuration may include sending configuration data to the hosts or communicating with a server or network device to direct data to particular data servers or datastores . For example a network load balancer device between the data servers and the hosts may be configured to direct some of the inbound data to a particular data server .

In some implementations block may backfill previously stored data from the first data structure in the second datastore to the second data structure in the second datastore . For example this backfill may be used during the initial stages of a migration to populate a new data structure.

Block receives from the second set of hosts at the second datastore data . As described above the data may include payload and metadata .

Block processes the data using the second data structure of the second datastore . For example the processing of the data may add a record to the second data structure .

At the second datastore based at least in part on the second synonym and the metadata block executes one or more triggers . As described above the triggers may be configured to propagate changes in the second data structure to the first data structure . Continuing the example the trigger may use the data to add a record to the first data structure .

For example the metadata may comprises a module name for a session with the datastore . The trigger module may compare the module name to the one or more trigger parameters . Based at least in part on the module name of the session corresponding to the one or more trigger parameters the trigger is executed.

To prevent situations where the same data is processed multiple times in some implementations the metadata may be modified. Continuing the example the module name of the session may be modified.

Block replicates from the second datastore to the first datastore the changes to the first data structure . Continuing the example the replication may transfer data which adds the record to the first data structure .

Block determines operation of the second data structure at the second datastore is acceptable. For example the administrators of the system may determine that testing indicates no problems and the second data structure is performing within specified bounds.

Block configures the first set of hosts to communicate with the second datastore or the second data server . This configuration may be based on the determination that operation of the second data structure is acceptable.

Block configures at the first datastore a first synonym to point to the second data structure in the first datastore . For example the first synonym data may specify CUST 124 . Based on this configuration subsequent incoming data will be provided to the second data structure . The datastores and have effectively swapped their roles in that the first datastore is now acting as the backup while the second datastore is now acting as the main.

Block receives at a replicated datastore data comprising payload and metadata . The replicated datastore may comprises a first data structure and a second data structure . For example the datastore may comprise a database having a first table and a second table.

Block accesses one or more trigger parameters . The trigger parameters may be provided manually by an administrator using the user interface module . In some implementations one or more of the trigger parameters may be associated with a particular data structure. For example the trigger parameters may be associated with the second table.

Block determines the metadata corresponds to the one or more trigger parameters . When the determination is such that a correspondence is present the process may proceed to block .

Block based at least in part on the correspondence of the metadata to the one or more trigger parameters performs one or more operations on the second data structure . The one or more operations may be configured to propagate the data or information based thereon to the first data structure . For example the data may be propagated from the second table to the first table.

Block modifies the metadata . The modification may be used to prevent or inhibit the one or more triggers from executing again with regard to the same piece of data . For example the metadata indicating the module name associated with the session for the data may be changed such that the module name no longer corresponds to the trigger parameters . In other implementations other techniques may be used to prevent duplicative processing of the data .

Returning to block when the metadata fails to correspond to one or more of the trigger parameters the process may proceed to block . Block discards the data .

Those having ordinary skill in the art will readily recognize that certain steps or operations illustrated in the figures above can be eliminated or taken in an alternate order. Moreover the methods described above may be implemented as one or more software programs for a computer system and are encoded in a computer readable storage medium as instructions executable on one or more processors.

The computer readable storage medium can be any one of an electronic storage medium a magnetic storage medium an optical storage medium a quantum storage medium and so forth. Separate instances of these programs can be executed on or distributed across separate computer systems. Thus although certain steps have been described as being performed by certain devices software programs processes or entities this need not be the case and a variety of alternative implementations will be understood by those having ordinary skill in the art.

Additionally those having ordinary skill in the art readily recognize that the techniques described above can be utilized in a variety of devices environments and situations.

Although the present disclosure is written with respect to specific embodiments and implementations various changes and modifications may be suggested to one skilled in the art and it is intended that the present disclosure encompass such changes and modifications that fall within the scope of the appended claims.

