---

title: Method and apparatus to distribute data center network traffic
abstract: Exemplary embodiments provide a technique to improve the system availability of the systems that have multiple links and are connected to a network fabric. In one embodiment, a switch comprises: a memory storing a first logical group which has a first plurality of IP addresses of a first plurality of ports and is assigned to a first ID (identifier), and a second logical group which has a second plurality of IP addresses of a second plurality of ports and is assigned to a second ID; and a controller controlling to cause a logical path of the first logical group to use a first physical path which is different from a second physical path to be used by a logical path of the second logical group, based on the first ID and the second ID.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09331946&OS=09331946&RS=09331946
owner: HITACHI, LTD.
number: 09331946
owner_city: Tokyo
owner_country: JP
publication_date: 20130108
---
The present invention relates generally to Data Center DC network system and more particularly to a method and an apparatus to distribute network traffic to multiple paths in a network fabric.

In recent years in data centers of cloud services the use of network fabrics is increasing to deal with increasing horizontal traffics among servers and storages in the data centers. The demand for rapid change of configuration and capacity is also driving the use of the network fabrics.

The network fabric has typically multiple paths between two nodes in a fabric to provide a load balancing feature and to improve fault tolerance of the network. A node in that has multiple outgoing ports distribute automatically incoming network traffics according to a rule. For example in a fabric with symmetric topology when an edge of the fabric receives an IP packet it makes hash values from the set of the source IP address and the destination IP address of the received packet. The hash values have the same hash length with the number of the multiple paths in the fabric. Mapping the hash values with the multiple paths the edge node transfers the packet via the corresponding path to the made hash value. In general the number of the set of the addresses is larger than the number of the multiple paths. Therefore the network traffics are distributed well randomly to the multiple paths.

However a failure in a network fabric affects strongly network traffics that are randomly distributed to multiple paths in the fabric. In more detail the failure affects multiple tenants using the fabric. As an example we suppose the case of a Web system composed of a Web server an application server and an iSCSI target connected sequentially by the fabric. The Web system contains two network links. These two links could be distributed to the multiple paths of the fabric. When two Web systems are connected to and overwrapped on the fabric one link failure can affect both of the two Web systems even if two links of a system are distributed to the multiple links. For example as shown in a link between a Web server and an application server of a Web system and a link between an application server and an iSCSI target of the other Web system can be assigned to the same physical link. Because each of the Web systems is affected even by a single link failure both of two tenants of the Web systems suffer a system failure and reduced system availability as shown in . As the complexity of tenant systems increases the number of tenants affected by a link failure increases.

U.S. Pat. No. 7 903 654 B2 provides a packet classifier and a method for routing a data packet. It discloses load sharing with the routes under Equal Cost Multi Paths ECMPs and more specifically a method of hardware support for ECMP by an indirect coupling between Content Addressable Memory CAM and Parameter Random Access Memory PRAM . It does not address the issues regarding system level availability of the present invention.

Exemplary embodiments of the invention provide a technique to improve the system availability of the systems that have multiple links and are connected to a network fabric. A network fabric system is composed of a network manager and multiple network switches distributing incoming network packets to the multiple connected network switches and has one or more of the following features. The network manager manages memberships of systems each of which is composed of one or multiple end nodes connected to the network fabric. The network manager also updates the system information according to its administrators configuration via its management interfaces. The network manager also applies the system information to network switches that stand on the edge of the network fabric and that receive network packets from the above end nodes. The edge network switches distribute the received network packets to multiple paths in the network fabric according to the above system information.

The first embodiment of the present invention is a network fabric system that manages the system s membership according to IP addresses of end nodes connected to the network fabric. The second embodiment is a network fabric system that manages the system s membership according to Virtual LAN VLAN ID. The third embodiment of the present invention is a network fabric system that manages the system s membership according to Virtual eXtensible LAN VXLAN ID. The network manager configures virtual switches running to apply VLAN ID to VXLAN packets.

In accordance with an aspect of the present invention a switch comprises a memory storing a first logical group which has a first plurality of IP addresses of a first plurality of ports and is assigned to a first ID identifier and a second logical group which has a second plurality of IP addresses of a second plurality of ports and is assigned to a second ID and a controller controlling to cause a logical path of the first logical group to use a first physical path which is different from a second physical path to be used by a logical path of the second logical group based on the first ID and the second ID.

In some embodiments the first logical group is assigned to the first ID by correlating the IP addresses of the first plurality of ports in the first logical group with the first ID and the second logical group is assigned to the second ID by correlating the IP addresses of the second plurality of ports in the second logical group with the second ID. The controller is configured for each packet received to read a source IP address of the received packet if the source IP address matches an IP address of the first plurality of ports or the second plurality of ports determine whether the source IP address is assigned to the first ID or the second ID if the source IP address is assigned to the first ID determine an outgoing port for the packet based on the first physical path and if the source IP address is assigned to the second ID determine an outgoing port for the packet based on the second physical path and if the source IP address does not match an IP address of the first plurality of ports and the second plurality of ports read a destination IP address of the received packet and determine whether the destination IP address matches an IP address of the first plurality of ports or the second plurality of ports if the destination IP address matches an IP address of the first plurality of ports or the second plurality of ports determine whether the destination IP address is assigned to the first ID or the second ID if the destination IP address is assigned to the first ID determine an outgoing port for the packet based on the first physical path and if the destination IP address is assigned to the second ID determine an outgoing port for the packet based on the second physical path and if the destination IP address does not match an IP address of the first plurality of ports and the second plurality of ports calculate a hash value of the source IP address and the destination IP address of the packet and select an outgoing port according to an order of the hash value based on a correlation between order of hash values and order of paths through a network fabric.

In specific embodiments the first logical group is assigned to the first ID by correlating VLAN Virtual Logical Area Network IDs of the first plurality of ports in the first logical group with the first ID and the second logical group is assigned to the second ID by correlating VLAN IDs of the second plurality of ports in the second logical group with the second ID. The controller is configured for each packet received to read a VLAN ID of the received packet if the VLAN ID of the received packet matches a VLAN ID of the first plurality of ports or the second plurality of ports determine whether the VLAN ID is assigned to the first ID or the second ID if the VLAN ID is assigned to the first ID determine an outgoing port for the packet based on the first physical path and if the VLAN ID is assigned to the second ID determine an outgoing port for the packet based on the second physical path and if the VLAN ID does not match a VLAN ID of the first plurality of ports and the second plurality of ports calculate a hash value of the VLAN ID of the packet and select an outgoing port according to an order of the hash value based on a correlation between order of hash values and order of paths through a network fabric.

In some embodiments the first logical group is assigned to the first ID by correlating VNIs VXLAN Virtual eXtensible LAN Network Identifiers of the first plurality of ports in the first logical group with the first ID and the second logical group is assigned to the second ID by correlating VNIs of the second plurality of ports in the second logical group with the second ID. The controller is configured for each packet received to read a VNI of the received packet if the VNI of the received packet matches a VNI of the first plurality of ports or the second plurality of ports determine whether the VNI is assigned to the first ID or the second ID if the VNI is assigned to the first ID determine an outgoing port for the packet based on the first physical path and if the VNI is assigned to the second ID determine an outgoing port for the packet based on the second physical path and if the VNI does not match a VNI of the first plurality of ports and the second plurality of ports calculate a hash value of the VNI of the packet and select an outgoing port according to an order of the hash value based on a correlation between order of hash values and order of paths through a network fabric.

Another aspect of the invention is directed to a computer readable storage medium storing a plurality of instructions for controlling a data processor to manage network traffic. The plurality of instructions comprise instructions that cause the data processor to store in a memory a first logical group which has a first plurality of IP addresses of a first plurality of ports and is assigned to a first ID identifier and a second logical group which has a second plurality of IP addresses of a second plurality of ports and is assigned to a second ID and instructions that cause the data processor to control to cause a logical path of the first logical group to use a first physical path which is different from a second physical path to be used by a logical path of the second logical group based on the first ID and the second ID.

Another aspect of this invention is directed to a method of controlling network traffic using a switch that includes a memory and a controller. The method comprises storing in the memory a first logical group which has a first plurality of IP addresses of a first plurality of ports and is assigned to a first ID identifier and a second logical group which has a second plurality of IP addresses of a second plurality of ports and is assigned to a second ID and controlling to cause a logical path of the first logical group to use a first physical path which is different from a second physical path to be used by a logical path of the second logical group based on the first ID and the second ID.

These and other features and advantages of the present invention will become apparent to those of ordinary skill in the art in view of the following detailed description of the specific embodiments.

In the following detailed description of the invention reference is made to the accompanying drawings which form a part of the disclosure and in which are shown by way of illustration and not of limitation exemplary embodiments by which the invention may be practiced. In the drawings like numerals describe substantially similar components throughout the several views. Further it should be noted that while the detailed description provides various exemplary embodiments as described below and as illustrated in the drawings the present invention is not limited to the embodiments described and illustrated herein but can extend to other embodiments as would be known or as would become known to those skilled in the art. Reference in the specification to one embodiment this embodiment or these embodiments means that a particular feature structure or characteristic described in connection with the embodiment is included in at least one embodiment of the invention and the appearances of these phrases in various places in the specification are not necessarily all referring to the same embodiment. Additionally in the following detailed description numerous specific details are set forth in order to provide a thorough understanding of the present invention. However it will be apparent to one of ordinary skill in the art that these specific details may not all be needed to practice the present invention. In other circumstances well known structures materials circuits processes and interfaces have not been described in detail and or may be illustrated in block diagram form so as to not unnecessarily obscure the present invention.

Furthermore some portions of the detailed description that follow are presented in terms of algorithms and symbolic representations of operations within a computer. These algorithmic descriptions and symbolic representations are the means used by those skilled in the data processing arts to most effectively convey the essence of their innovations to others skilled in the art. An algorithm is a series of defined steps leading to a desired end state or result. In the present invention the steps carried out require physical manipulations of tangible quantities for achieving a tangible result. Usually though not necessarily these quantities take the form of electrical or magnetic signals or instructions capable of being stored transferred combined compared and otherwise manipulated. It has proven convenient at times principally for reasons of common usage to refer to these signals as bits values elements symbols characters terms numbers instructions or the like. It should be borne in mind however that all of these and similar terms are to be associated with the appropriate physical quantities and are merely convenient labels applied to these quantities. Unless specifically stated otherwise as apparent from the following discussion it is appreciated that throughout the description discussions utilizing terms such as processing computing calculating determining displaying or the like can include the actions and processes of a computer system or other information processing device that manipulates and transforms data represented as physical electronic quantities within the computer system s registers and memories into other data similarly represented as physical quantities within the computer system s memories or registers or other information storage transmission or display devices.

The present invention also relates to an apparatus for performing the operations herein. This apparatus may be specially constructed for the required purposes or it may include one or more general purpose computers selectively activated or reconfigured by one or more computer programs. Such computer programs may be stored in a computer readable storage medium including non transient medium such as but not limited to optical disks magnetic disks read only memories random access memories solid state devices and drives or any other types of media suitable for storing electronic information. The algorithms and displays presented herein are not inherently related to any particular computer or other apparatus. Various general purpose systems may be used with programs and modules in accordance with the teachings herein or it may prove convenient to construct a more specialized apparatus to perform desired method steps. In addition the present invention is not described with reference to any particular programming language. It will be appreciated that a variety of programming languages may be used to implement the teachings of the invention as described herein. The instructions of the programming language s may be executed by one or more processing devices e.g. central processing units CPUs processors or controllers.

Exemplary embodiments of the invention as will be described in greater detail below provide apparatuses methods and computer programs for distributing network traffic to multiple paths in a network fabric. More specifically embodiments of the present invention provide a network fabric system that manages the system information composed of a set of an identity of end node and an identity of a group of one or multiple end nodes and at the entrance of the network fabric providing multiple paths select an appropriate path for each packet so as to transfer the packets of a system to the same path.

The switch device retrieves an attribute of the outgoing interface from the distributed configuration step . It then checks if the outgoing interface is a member of an aggregated logical interface step . Actually it defines the outgoing interface as the member if the aggregation ID column of the distribution configuration contains any integer value. If the checked outgoing interface is a member of an aggregated logical interface the switch device starts to select an actual physical outgoing port in the aggregated logical interface step . The detail of this process is described later see . After selecting the actual outgoing port it sends the packet from the selected outgoing port step and terminates the process regarding the received packet step . If the checked outgoing interface is not a member of an aggregated logical interface the switch device sends the packet from the checked outgoing interface without additional process step and terminates the process regarding the received packet step .

If a valid entry exists the switch device sets the system ID in the retrieved entry as the selected system ID for the received packet step . It then retrieves a distributed route ID corresponding to the selected system ID from the distributed route information step . The distributed route ID represents the order of the selected fabric switch as described above. It directly corresponds to an outgoing port. If a valid entry does not exist to select an outgoing port according to some other attributes the switch device then reads the destination IP address from the received packet step and retrieves a system ID corresponding to the destination IP address from the system information step . It then checks if the valid entry exists in the system information step .

If a valid entry exists in the system information it sets the system ID of the retrieved valid entry as the selected system ID step . Then it retrieves an outgoing port from the distributed route information step . It then ends the process of selecting an outgoing port . If a valid entry does not exist in the system information it calculates a hash of the set of the source IP address and the destination IP address step and selects an outgoing port according to an order of the hash value in the distributed route information step . It then ends the process of selecting an outgoing port .

In this case with a prior method to aggregate network traffics for each VLAN the port switches select the destination fabric switch according to VLAN IDs in the VLAN tags. However as same with the case of the selection according to IP addresses multiple tenants could be affected by a single link failure because each tenant might use multiple VLANs to form a system including multiple servers such as 3 tier Web systems. The network manager and port switches of the second embodiment manage the mapping of VLAN IDs to system ID. The port switches then forward selects an outgoing port and destination fabric switch according to the system ID instead of the VLAN IDs.

If the checked outgoing interface is a member of an aggregated logical interface the switch device starts to select an actual physical outgoing port in the aggregated logical interface step . The detail of this process is described later . After selecting the actual outgoing port it sends the packet from the selected outgoing port step and terminates the process regarding the received packet step .

If the checked outgoing interface is not a member of an aggregated logical interface the switch device sends the packet from the checked outgoing interface without additional process step and terminates the process regarding the received packet step .

If a valid entry exists the switch device sets the system ID in the retrieved entry as the selected system ID for the received packet step . It then retrieves a distributed route ID corresponding to the selected systems ID from the distributed route information step . The distributed route ID represents the order of the selected fabric switch as described above in connection with . It directly corresponds to an outgoing port. It then ends the process of selecting an outgoing port step .

If a valid entry does not exist to select an outgoing port according to some other attributes the switch device calculates a hash of the VLAN ID of the received packet with the length of the number of physical ports of the retrieved aggregated logical interface step . It then selects an outgoing port from the distributed route information according to an order of the hash value step . It then ends the process of selecting an outgoing port step .

In this embodiment the virtual switches and manage the relationship between network segments identified by the VXLAN Network Identifier VNI and systems. According to this information the virtual switches and append VLAN tags and VXLAN headers to packets received from end nodes and forward the packets to port switches . The VLAN tags contain VLAN IDs which have the same number as the system ID in the system information.

If the checked outgoing interface is a member of an aggregated logical interface the switch device starts to select an actual physical outgoing port in the aggregated logical interface step . The detail of this process is described later . After selecting the actual outgoing port it sends the packet from the selected outgoing port step and terminates the process regarding the received packet step .

If the checked outgoing interface is not a member of an aggregated logical interface the switch device sends the packet from the checked outgoing interface without additional process step and terminates the process regarding the received packet step .

If a valid entry exists the switch device sets the system ID in the retrieved entry as the selected system ID for the received packet . It then retrieves a distributed route ID corresponding to the selected system ID from the distributed route information step . The distributed route ID represents the order of the selected fabric switch as described above in connection with . It directly corresponds to an outgoing port. It then ends the process of selecting an outgoing port step .

If a valid entry does not exist to select an outgoing port according to some other attributes the switch device calculates a hash of the VNI of the received packet with the length of the number of physical ports of the retrieved aggregated logical interface step . It then selects an outgoing port from the distributed route information according to an order of the hash value step . It then ends the process of selecting an outgoing port step .

The network system contains network manager a management LAN port switches that have flow tables . The network manager has a memory a CPU I O a NIC and a storage device . The memory stores distribution configuration information which is equivalent to the distribution configuration information of the first embodiment. It also stores distributed route configuration information which is equivalent to the distributed route information in the first embodiment. It also stores the system information which is equivalent to the system information and in the first the second and the third embodiment respectively. It also stores flow tables for port switches . It also executes the system information management program and OS .

With the architecture the outgoing port selection process of the switch device and according to the respective flow diagrams in and is implemented as a software module on the network manager and respectively. When the packet that have not been learned arrives a port switch the port switch forwards the packet to the network manager . Then system information management program of the network manager and asks port switches and to configure their flow tables so that they forward received packets according to the results of the outgoing port selection process.

For the system of the first embodiment the network manager adds a source IP address of the received packet into the match field of a flow entry. It also sets the identifier of the packet forwarding action with the selected outgoing physical port into the instruction field of the flow entry.

For the system of the second embodiment the network manager adds a VLAN ID of the received packet into the match field of a flow entry. It also set the identifier of the packet forwarding action with the selected outgoing physical port into the instruction field of the flow entry.

For the system of the third embodiment the network manager adds a VNI of the received packet into the match field of a flow entry. It also set the identifier of the packet forwarding action with the selected outgoing physical port into the instruction field of the flow entry.

Of course the system configurations illustrated in are purely exemplary of information systems in which the present invention may be implemented and the invention is not limited to a particular hardware configuration. The computers and storage systems implementing the invention can also have known I O devices e.g. CD and DVD drives floppy disk drives hard drives etc. which can store and read the modules programs and data structures used to implement the above described invention. These modules programs and data structures can be encoded on such computer readable media. For example the data structures of the invention can be stored on computer readable media independently of one or more computer readable media on which reside the programs used in the invention. The components of the system can be interconnected by any form or medium of digital data communication e.g. a communication network. Examples of communication networks include local area networks wide area networks e.g. the Internet wireless networks storage area networks and the like.

In the description numerous details are set forth for purposes of explanation in order to provide a thorough understanding of the present invention. However it will be apparent to one skilled in the art that not all of these specific details are required in order to practice the present invention. It is also noted that the invention may be described as a process which is usually depicted as a flowchart a flow diagram a structure diagram or a block diagram. Although a flowchart may describe the operations as a sequential process many of the operations can be performed in parallel or concurrently. In addition the order of the operations may be re arranged.

As is known in the art the operations described above can be performed by hardware software or some combination of software and hardware. Various aspects of embodiments of the invention may be implemented using circuits and logic devices hardware while other aspects may be implemented using instructions stored on a machine readable medium software which if executed by a processor would cause the processor to perform a method to carry out embodiments of the invention. Furthermore some embodiments of the invention may be performed solely in hardware whereas other embodiments may be performed solely in software. Moreover the various functions described can be performed in a single unit or can be spread across a number of components in any number of ways. When performed by software the methods may be executed by a processor such as a general purpose computer based on instructions stored on a computer readable medium. If desired the instructions can be stored on the medium in a compressed and or encrypted format.

From the foregoing it will be apparent that the invention provides methods apparatuses and programs stored on computer readable media for distributing network traffic to multiple paths in a network fabric. Additionally while specific embodiments have been illustrated and described in this specification those of ordinary skill in the art appreciate that any arrangement that is calculated to achieve the same purpose may be substituted for the specific embodiments disclosed. This disclosure is intended to cover any and all adaptations or variations of the present invention and it is to be understood that the terms used in the following claims should not be construed to limit the invention to the specific embodiments disclosed in the specification. Rather the scope of the invention is to be determined entirely by the following claims which are to be construed in accordance with the established doctrines of claim interpretation along with the full range of equivalents to which such claims are entitled.

