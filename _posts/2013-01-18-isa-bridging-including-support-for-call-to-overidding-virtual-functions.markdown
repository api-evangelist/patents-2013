---

title: ISA bridging including support for call to overidding virtual functions
abstract: Methods, apparatuses and storage medium associated with ISA bridging with support for virtual functions, are disclosed. In embodiments, at least one computer-readable storage medium may include instructions configured to enable a target device with a target ISA, in response to execution, to provide an ISA bridging layer to the target device to facilitate a library service of a library of the target device to call a virtual function of the library, while servicing an application operating on the target device, where the application has an overriding implementation. The ISA bridging layer may include a loader configured to load the application for execution, and as part of loading the application, detect the virtual function and modify a virtual function table of the application to enable the call. Other embodiments may be disclosed or claimed.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08768682&OS=08768682&RS=08768682
owner: Intel Corporation
number: 08768682
owner_city: Santa Clara
owner_country: US
publication_date: 20130118
---
This present application claims priority under 35 U.S.C. 119 and 365 a to International Application No. PCT CN2012 079798 filed Aug. 8 2012 entitled ISA BRIDGING INCLUDING SUPPORT FOR CALL TO OVERIDDING VIRTUAL FUNCTIONS which designated the United States of America and at least one country other than the United States. The entire contents of International Application No. PCT CN2012 079798 is hereby incorporated by reference in its entirety.

This application is technically related to Patent Cooperation Treaty Application No. PCT CN2012 070163 filed Jan. 10 2012 entitled ISA Bridging with Callback which designated the United States of America and at least one country other than the United States.

The background description provided herein is for the purpose of generally presenting the context of the disclosure. Unless otherwise indicated herein the materials described in this section are not prior art to the claims in this application and are not admitted to be prior art by inclusion in this section.

A computing device may be characterized by its Instruction Set Architecture ISA . Typically a computing device may include Operating System OS services and the OS services may include the runtime library services LIB developed for the ISA of the computing device to facilitate application developers to develop applications to operate on the computing device. For example various smartphones may be characterized by the use of the ARM processor and its ISA. These smartphones may include an OS e.g. iOS or Android in support of the various applications developed for the respective smartphones. Some computing devices offer an ISA independent execution environment such as Java or Android Application Framework. However a large number of applications nonetheless include ISA dependent portions that invoke services of ISA dependent runtime libraries. Further these ISA dependent portions often include callback functions requiring callbacks from the ISA dependent runtime libraries and such callbacks are often not discovered until runtime rendering traditional approaches such as binary translation inadequate in addressing the needs. Additionally these ISA dependent portions may also include overriding implementations of inheritable virtual functions of the ISA dependent runtime libraries that need to be properly called when the virtual functions are called. The traditional approaches such as binary translation are likewise inadequate in addressing the needs.

Methods apparatuses and storage medium associated with ISA bridging with callback and virtual function support are disclosed. In various embodiments at least one computer readable storage medium may include instructions configured to enable a target device with a target ISA in response to execution of the instructions to provide an ISA bridging layer to the target device to facilitate a library service of a library of the target device to call a virtual function of the library while servicing an application. The library service may be implemented for the target ISA and the application may be implemented at least partially for a source ISA that may be different from the target ISA and includes a class with an overriding implementation of the virtual function. The ISA bridging layer may include a loader configured to load the application for execution and as part of the loading detect the virtual function and modify a virtual function table of the application to enable in response to the call execution control be transferred across the source and target instruction set architectures to the overriding implementation of the virtual function. The ISA bridging layer in embodiments may further include a source ISA emulator and a library emulator configured to cooperate to enable the execution control transfer in response to the call as well as the application to call the library service and the library service to callback the callback function across the ISAs.

Various aspects of the illustrative embodiments will be described using terms commonly employed by those skilled in the art to convey the substance of their work to others skilled in the art. However it will be apparent to those skilled in the art that alternate embodiments may be practiced with only some of the described aspects. For purposes of explanation specific numbers materials and configurations are set forth in order to provide a thorough understanding of the illustrative embodiments. However it will be apparent to one skilled in the art that alternate embodiments may be practiced without the specific details. In other instances well known features are omitted or simplified in order not to obscure the illustrative embodiments.

Various operations will be described as multiple discrete operations in turn in a manner that is most helpful in understanding the illustrative embodiments however the order of description should not be construed as to imply that these operations are necessarily order dependent. In particular these operations need not be performed in the order of presentation. Further descriptions of operations as separate operations should not be construed as requiring that the operations be necessarily performed independently and or by separate entities. Descriptions of entities and or modules as separate modules should likewise not be construed as requiring that the modules be separate and or perform separate operations. In various embodiments illustrated and or described operations entities data and or modules may be merged broken into further sub parts and or omitted.

The phrase in one embodiment or in an embodiment is used repeatedly. The phrase generally does not refer to the same embodiment however it may. The terms comprising having and including are synonymous unless the context dictates otherwise. The phrase A B means A or B . The phrase A and or B means A B or A and B . The phrase at least one of A B and C means A B C A and B A and C B and C or A B and C .

In embodiments application may be object oriented or include classes . For these embodiments application may include objects classes with one or more overriding implementations of virtual functions inherited from target ISA library services . Additionally application may include one or more virtual function tables for storing these overriding implementations of the virtual functions inherited from the target ISA library services hereinafter simply overriding implementations . The one or more virtual function tables may further include associated metadata describing the overriding implementations . In embodiments application may further include a relocation table containing symbol names and other information that facilitate runtime resolution of the portions unresolved at compile time.

In embodiments ISA bridging layer may include support for execution control to be properly transferred across the different ISA to these overriding implementations when various ones of library services call the virtual function. Various embodiments of ISA bridging layer will be further described below. ISA bridging layer may also be referred to as a process virtual machine PVM .

Computing device may be a server a desktop computer a laptop computer a tablet computer a smartphone a personal digital assistant a game console an Internet appliance or other computing devices of the like. Examples of computing device may include but are not limited to the servers available from Hewlett Packard of Palo Alto Calif. desktop or laptop computers available from Dell Computer of Austin Tex. smartphones and computing tablets available from Apple Computer of Cupertino Calif. game console available from Nintendo Corporation of Tokyo Japan and so forth.

Processor and memory arrangement is intended to represent a broad range of processor and memory arrangements including but not limited to arrangements with single or multi core processors of various execution speeds and power consumptions and memory of various architectures with one or more levels of caches and of various types such as dynamic random access FLASH and so forth. In various embodiments GPU may be configured to provide video decoding and or graphics processing functions to OS while display unit may be configured to enable multi media content e.g. HD video to be rendered thereon. Similarly GPU and display unit are intended to represent a broad range of graphics processors and display elements known in the art. Likewise network s is are intended to represent a broad range of networks known in the art. Examples of network s may include wired or wireless local or wide area private or public networks including the Internet.

OS including library services except for the application programming interface API defining invocation of library service is intended to represent a broad range of operating system elements known in the art. OS may include conventional components such as a kernel configured to manage memory resources schedule task execution and so forth and device drivers configured to manage various device resources. In embodiments OS may include a virtual machine in support of middleware if employed e.g. Android s virtual machine in support of the Android application framework. For the embodiments in addition to defining invocations of library services to facilitate invocation of callback functions of application the API of library services may also include the corresponding stubs and signatures of callback functions of application . Examples of OS may include but are not limited to Windows operating systems available from Microsoft Corporation of Redmond Wash. Linux available from e.g. Red Hat of Raleigh N.C. Android developed by the Open Handset Alliance or iOS available from Apple Computer of Cupertino Calif.

Similarly middleware is intended to represent a broad range of middleware elements known in the art including but not limited to ISA independent middleware. Examples of middleware may include but are not limited to Android Application Framework Java or other application frameworks or ISA independent execution environments.

Likewise application including callback functions overriding implementations etc is intended to represent a broad range of applications known in the art. Examples of application may include but are not limited to personal assistant productivity or social networking applications such as calendar word processing spreadsheet Twitter Facebook et al or generic application agents such as a browser. Examples of a browser may include but are not limited to Internet Explorer available from Microsoft Corporation of Redmond Wash. or Firefox available from Mozilla of Mountain View Calif.

Referring now to wherein illustrated is an example ISA bridging layer in accordance with various embodiments of the present disclosure. As shown for the embodiments ISA bridging layer may include ISA bridging loader source ISA emulator and target ISA Library emulator hereinafter simply LIB emulator configured to provide various runtime features and services including but not limited to dynamic binding services. Source ISA emulator may include source ISA context and binary translation engine . Source ISA emulator may maintain in source ISA context the execution context of source ISA architecture including but not limited to e.g. the current execution instruction pointer IP . Binary translator engine may be configured to translate source ISA instructions to target ISA instructions. LIB emulator may include target ISA Library LIB context gates and wrapper functions . LIB emulator may maintain in target ISA Library LIB context the execution context of target ISA Library. In various embodiments there may also be one corresponding pair of gate and wrapper function per library service configured to facilitate calling of library service by application across the source and target ISA architectures. Similarly there may be one corresponding pair of gate and wrapper function per callback function and per overriding implementations configured to facilitate callback of callback function by library services across the target and source ISA architectures and transfer of execution control to the overriding implementations across the target and source ISA architectures when the virtual functions are called.

ISA bridging loader may be configured to load application . In loading application ISA bridging loader may be configured to resolve any unresolved symbolic names of application associated with calling library services to appropriate ones of the library services . In embodiments ISA bridging loader may be configured to resolve any unresolved symbolic names of application associated with calling library services to addresses of the corresponding gates of library services . Additionally ISA bridging loader may be configured to modify the symbolic names or references to callback functions to internal names and associate the symbolic names or references to callback functions to the corresponding wrapper functions .

Further ISA bridging loader may further include pseudo linker functions configured to resolve the various overriding implementations when loading application for execution. ISA bridging loader in embodiments as part of the loading may identify overriding implementations using information in relocation table . ISA bridging loader in embodiments may be further configured to make possible for execution control to be transferred across the ISA to overriding implementations if appropriate when library services call the virtual functions by modifying virtual function tables replacing entries in virtual function tables with corresponding wrapper functions. In embodiments the wrapper functions may include pointers to the overriding implementations .

ISA bridging loader may gain control of the loading from the loader of OS or middleware if employed in any one of a number of known manners. Examples of such known manners may include the use of binary format based control transfer or load pre load variables when supported by OS or middleware . In other embodiments the loader of OS or middleware if employed may be modified to facilitate the transfer of control to ISA bridging loader instead.

As described earlier source ISA emulator may be configured to maintain source ISA execution context . Source ISA emulator may be configured to track the source ISA IP instruction pointer during execution of application . When application attempts to invoke a library service source ISA emulator monitoring source ISA execution may invoke and transfer execution control to LIB emulator instead. In various embodiments source ISA emulator may invoke and transfer execution control to the corresponding gate of the library service .

Gates corresponding to library services may be configured to respectively redirect calls to library services to the corresponding wrapper functions to process and set up the calls. Whereas gates corresponding to callback functions or overriding implementations may be configured to respectively transfer execution control for callbacks or calls to the virtual functions from the corresponding wrapper functions to source ISA emulator . In various embodiments each gate may include an instruction configured to effectuate the redirect to the corresponding wrapper function or source ISA emulator . In various embodiments the instruction of each gate may be a source ISA instruction configured to cooperate with the binary translation engine to effectuate execution control redirection. In various embodiments each gate may further include an indicator identifying the corresponding wrapper function .

In various embodiments for processing and setting up a call to the corresponding library service each wrapper function corresponding to a library service may be configured to retrieve the associated parameter values of the call from source ISA context convert the call from the source ISA application binary interface ABI format to the target ISA ABI format and save the converted call with the parameter values in LIB context .

On a callback to a callback function or a call to an overridden virtual function execution control may be transferred to the corresponding wrapper function of callback function or overriding implementations . In various embodiments for processing and setting up a callback to a callback function or transfer of execution control to overriding implementation of application each wrapper function corresponding to a callback function or an overriding implementation may be configured to convert the callback or call to the overridden virtual function from the target ISA ABI format to the source ISA ABI format attach the associated parameter values of the callback or call to the overridden virtual function and save the converted callback or call to the overridden virtual function with the parameter values in source ISA context .

Gates corresponding to a callback function or an overriding implementation may be configured to invoke the source ISA emulator with the source ISA context prepared by wrapper function corresponding to the callback function or overriding implementation to emulate the callback function or overriding implementation presented in Source ISA format on target ISA.

Referring now to wherein illustrated is an example ISA bridging method with callback and virtual function support in accordance with various embodiments of the present disclosure. As shown method may include two parts part for bridging calls from application of source ISA to library services of target ISA and part for bridging callbacks from a library service of target ISA to a callback function of application of source ISA or proper transfer of execution control to an overriding implementation .

Part may begin at block . At block ISA bridging loader may load application . In loading application ISA bridging loader may resolve the symbolic names or references of application to library services and modify symbolic names or references of callback functions . Further ISA bridging loader may detect identify overriding implementations using relocation table and modify virtual function tables as earlier described. The process is illustrated in further details in .

Referring now to as illustrated process may start at block . At block loader may retrieve the current entry in relocation table . From block process may proceed to block . At block loader may determine if the fix up address in the retrieved entry belongs to a virtual function table . If a result of the determination is affirmative process may proceed to block . At block loader may further determine if the fix up address is associated with a virtual function. If a result of the determination is affirmative process may proceed to block . At block loader may further determine if the virtual function has been overridden. If a result of the determination is again affirmative process may proceed to block . At block loader may replace the entry in the virtual function table with a corresponding wrapper function that includes a pointer to the overriding implementation .

If a result of the determination in block or is negative process may proceed to block . At block loader may determine if another entry in relocation table is available. If a result of the determination is affirmative process may proceed to block . At block loader may move to the next entry in relocation table . From block process may proceed to block and repeat the process as earlier described.

Referring now back to from block part may proceed to block . At block in the course of execution application may call one of library services . In various embodiments application may require a callback to one of its callback functions by the called library service . In embodiments application may include as part of the call to the called library service a pointer to the callback function to be callback. Instead of passing the pointer to the callback function the wrapper function of the library service may pass the corresponding wrapper function of the call back function .

For some calls objects classes with overriding implementations and virtual function tables modified as earlier described may be passed to the library having library services .

From block part may proceed to block . At block source ISA emulator on detection of the call through e.g. monitoring of the source ISA IP and determining that the IP is referencing an address within the address scope of the target library may redirect the call and transfer execution control to the corresponding gate of the library service in LIB emulator . From block part may proceed to block . At block gate may further redirect the call and transfer execution control to the corresponding wrapper function of the called library service . From block part may proceed to block . At block wrapper function of the called library service may process the call and set up the call in LIB context for execution by the called library service as earlier described. From block part may proceed to block . At block gate of the called library service may collect the return value s of the call from LIB context update source ISA context and transfer execution control to source ISA emulator to return the return values of the library service call to application .

Referring now to part may begin at block . At block in the course or on completion of a called library service the library service may callback a callback function of application e.g. by calling the callback pointer passed by application or call a virtual function of the library that has been overridden by an implementation of application . From block part may proceed to block as the callback call pointer is the wrapper function corresponding to the callback function or overriding implementation . At block execution control may be transferred to the corresponding wrapper function of callback function or overriding implementation in accordance with the modified reference. From block part may proceed to block . At block wrapper function may process the callback call set up the callback call in source ISA context for execution by the callback function or overriding implementation of application as described earlier and thereafter transfer execution control to the corresponding gate of the callback function or overriding implementation . From block part may proceed to block . At block gate corresponding to the callback function or overriding implementation may redirect the callback call and transfer execution control to the ISA emulator with the source ISA context prepared by the wrapper function .

Further at block on detection of the call through e.g. monitoring of the source ISA IP and determining that the IP is referencing an address within the address scope of the gates corresponding to callback functions or overriding implementation source ISA emulator may redirect the source ISA IP to the callback function or overriding implementation to continue the emulation. From block part may proceed to block . At block gate of the callback function or overriding implementation may collect the return value s of the callback or call from source ISA context update LIB context and transfer execution control to LIB emulator to return the return values of the callback function or overriding implementation to the library service .

Referring back to for one embodiment at least one of the processor s of processor and memory arrangement may be packaged together with the computational logic or a subset thereof of ISA bridging layer configured to practice the operations or a subset thereof of method of . For one embodiment at least one of the processor s of processor and memory arrangement may be packaged together with the computational logic or a subset thereof of ISA bridging layer configured to practice the operations or a subset thereof of method of to form a System in Package SiP . For one embodiment at least one of the processor s of processor and memory arrangement may be integrated on the same die with the computational logic or a subset thereof of ISA bridging layer configured to practice the operations or a subset thereof of method of . For one embodiment at least one of the processor s of processor and memory arrangement may be integrated on the same die with the computational logic or a subset thereof of ISA bridging layer configured to practice the operations or a subset thereof of method of to form a System on Chip SoC . For at least one embodiment the SoC may be utilized in a desktop computer a laptop computer a smartphone a computing tablet an Internet appliance a personal digital assistant PDA a portable game playing device a server or other computing devices.

Still referring to while for ease of understanding the present disclosure has been described with one ISA bridging layer bridging one source ISA to one target ISA. However the present disclosure is not so limited. In embodiments multiple different ISA bridging layers may be provided to bridge multiple different source ISA to the target ISA. In some of these embodiments a dispatcher may additionally be provided to detect the bridging required and instantiates the appropriate ISA bridging layer or layers to provide the required ISA bridging.

Further in various embodiments the present disclosure may be practiced with substituted binaries in target ISA for portions of application in source ISA to reduce the amount of bridging needed. In other embodiments some of the resources used for bridging e.g. some of the wrapper functions may be located on a remote server accessible to ISA bridging layer .

Still further while for ease of understanding ISA bridging layer has been described as being configured to bridge source ISA and target ISA that are different. However the disclosure is not so limited. It is contemplated that for various applications ISA bridging layer may be employed to bridge source ISA and target ISA that are the same. In such applications one or more of the described elements e.g. binary translation engine may not be needed. An example of such application may be to provide enhanced operational security to computing device . Other applications may likewise benefit from such bridging.

Thus although specific embodiments have been illustrated and described herein it will be appreciated by those of ordinary skill in the art that a wide variety of alternate and or equivalent implementations may be substituted for the specific embodiments shown and described.

Accordingly it will be appreciated that the present disclosure may be a solution to the technical problem of a computing device with one ISA supporting applications developed for another ISA where the applications have usage characteristics of requiring on occasions callbacks from the called library services or calls to virtual functions of the library with overriding implementations by the application. The advantage of the present disclosure may include but is not limited to avoiding the need to fully translate or re implement the application in the computing device s ISA.

It will also be appreciated that the present disclosure may be a solution to the technical problem of providing enhanced security to a computing device. The advantage of the present disclosure may include but is not limited to the robustness of the isolation provided.

In particular what has been disclosed include but not limited to at least one computer readable storage medium having instructions configured to enable a target device with a target instruction set architecture in response to execution of the instructions to provide an instruction set architecture bridging layer to the target device to facilitate a library service of a library of the target device to call a virtual function of the library while servicing an application operating on the target device. The library service may be implemented for the target instruction set architecture and the application may be implemented at least partially for a source instruction set architecture and includes a class with an overriding implementation of the virtual function. Further the instruction set architecture bridging layer may include a loader configured to load the application for execution and as part of loading the application detect the overriding implementation of the virtual function and modify a virtual function table of the class to enable in response to the call execution control be transferred across the source and target instruction set architectures to the overriding implementation of the virtual function.

In embodiments the loader may be configured to traverse a relocation table of the application to detect the overriding implementation of the virtual function. In embodiments the loader may be configured to modify the virtual function table to replace the overriding implementation of the virtual function with a corresponding wrapper function of the overriding implementation of the virtual function that includes a pointer to the overriding implementation of the virtual function.

In embodiments the instruction set architecture bridging layer may further include a source instruction set architecture emulator and a library emulator configured to cooperate to facilitate the transfer of execution control across the source and target instruction set architectures to the overriding implementation of the virtual function including facilitation of transfer of the class across the source and target instruction set architectures to the library.

In embodiments the source instruction set emulator may be configured to maintain an execution context of the source instruction set architecture and the library emulator is configured to maintain a library execution context. The library emulator may be further configured to redirect the call to the corresponding wrapper function of the overriding implementation of the virtual function to process the call set up the call in the execution context of the source instruction set architecture and redirect the call to a corresponding gate. Additionally the library emulator may include the corresponding gate configured to redirect the call to the source ISA instruction emulator. The source ISA instruction emulator may be further configured to redirect the call to the overriding implementation of the virtual function. The source instruction set architecture and the target instruction set architecture may be the same instruction set architecture.

Further a method for bridging a source instruction set architecture to a target instruction set architecture with virtual function support has been disclosed. The method may include loading an application for execution by a loader of an instruction set architecture bridging layer operated by a computing device wherein the application is implemented at least partially for a source instruction set architecture including at least a class having an overriding implementation of a virtual function of a library of the computing device and wherein the computing device implements the target instruction set architecture. Additionally the method may include as part of the loading detecting by the loader the overriding implementation of the virtual function and modifying by the loader a virtual function table of the class to enable execution control be transferred across the source and target instruction set architectures to the overriding implementation of the virtual function in response to a library service of the library calling the virtual function upon passing the class to the library after modification.

In embodiments detecting may include traversing by the loader a relocation table of the application to detect the overriding implementation of the virtual function. Modifying may include modifying the virtual function table to replace the overriding implementation of the virtual function with a corresponding wrapper function that includes a pointer to the overriding implementation of the virtual function.

In embodiments the method may further include maintaining a source ISA architecture execution context by a source instruction set architecture emulator of the instruction set architecture bridging layer maintaining a library execution context by a library emulator of the instruction set architecture bridging layer and cooperating between the instruction set architecture emulator and the library emulator to facilitate transfer of execution control to the overriding implementation of the virtual function across the source and target instruction set architectures in response to a call of the virtual function by a library service of the library upon passing the class to the library.

In embodiments the method may further include redirecting by the library emulator the call to a wrapper function of the library emulator corresponding to the overriding implementation virtual function to process the call and set up the call in the execution context of the source instruction set architecture redirecting the call to the source ISA instruction emulator by a gate of the library emulator corresponding to the wrapper function of the overriding implementation of the virtual function and or redirecting the call by the source ISA instruction emulator to the overriding implementation of the virtual function.

Still further an apparatus for executing an application implemented at least partially in a source instruction set architecture has been disclosed. The apparatus may include a processor and memory arrangement having a target instruction set architecture and an instruction set architecture bridging layer including a loader configured to load an application for execution the application implemented at least partially for a source instruction set architecture and includes a class having an overriding implementation of a virtual function of a library implemented for the target instruction set architecture. The loader may be configured to as part of loading the application detect the overriding implementation of the virtual function and modify a virtual function table of the class to enable execution control be transferred across the source and target instruction set architectures to the overriding implementation of the virtual function in response to a call of the virtual function by a library service of the library after passing the class to the library.

In embodiments the loader may be configured to traverse a relocation table of the application to detect the overriding implementation of the virtual function. The loader may be configured to modify the virtual function table to replace the overriding implementation of the virtual function with a corresponding wrapper function that includes a pointer to the implementation of the virtual function. The instruction set architecture bridging layer may further include an instruction source architecture emulator and a library emulator configured to be operated by the processor and memory to cooperate to effectuate the execution control transfer to the overriding implementation of the virtual function across the source and target instruction set architectures in response to the call of the virtual function by the library service after passing of the class to the library.

In embodiments the source instruction set emulator may be configured to maintain an execution context of the source instruction set architecture and the library emulator is configured to maintain a library execution context. The library emulator may further include a wrapper function corresponding to the overriding implementation of the virtual function configured to process the call set up the call in the execution context of the source instruction set architecture and redirect the call to a corresponding gate. The library emulator may further include the corresponding gate configured to redirect the call to the source ISA instruction emulator. The ISA instruction emulator may be further configured to redirect the call to the overriding implementation of the virtual function.

In embodiments the apparatus may be a selected one of a server a desktop computer a laptop computer a tablet computer a smartphone a personal digital assistant a game console or an Internet appliance. The processor may be a multi core processor. The apparatus may include an operating system having the library of services. The apparatus may further include an instruction set architecture independent application execution environment wherein the application further uses at least one other service of the instruction set architecture independent application execution environment.

